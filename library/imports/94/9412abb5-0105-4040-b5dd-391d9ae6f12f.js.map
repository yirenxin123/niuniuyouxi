{
  "version": 3,
  "sources": [
    "unknown"
  ],
  "names": [
    "AssetsManager",
    "require",
    "amManager",
    "cc",
    "Class",
    "ctor",
    "_updates",
    "_queue",
    "_isUpdating",
    "_current",
    "_noComplete",
    "getModules",
    "remoteVersionCb",
    "sys",
    "isNative",
    "game",
    "asset",
    "check",
    "modules",
    "versions",
    "bind",
    "load",
    "data",
    "localStorage",
    "getItem",
    "json",
    "JSON",
    "parse",
    "i",
    "length",
    "removeItem",
    "getProgress",
    "name",
    "am",
    "init",
    "onCheckComplete",
    "onComplete",
    "onProgress",
    "onNewVersion",
    "AssetConfig",
    "concurrent",
    "on",
    "AssetEvent",
    "NEW_VERSION",
    "PROGRESS",
    "FAILD",
    "_onFailed",
    "NEW_VERSION_FOUND",
    "_onCheckComplete",
    "SUCCESS",
    "_onUpdateComplete",
    "REMOTE_VERSION_MANIFEST_LOAD_FAILD",
    "_onNetError",
    "REMOTE_PROJECT_MANIFEST_LOAD_FAILD",
    "NO_NETWORK",
    "isNoComplete",
    "recovery",
    "event",
    "target",
    "push",
    "_saveNoCompleteModule",
    "update",
    "shift",
    "names",
    "setItem",
    "stringify"
  ],
  "mappings": "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",
  "file": "unknown",
  "sourcesContent": [
    "/** \r\n * 热更新管理\r\n * Author      : donggang\r\n * Create Time : 2016.7.29\r\n * \r\n * 需求说明:\r\n * 1、可后台更新版本资源\r\n */\r\n\r\nvar AssetsManager = require(\"AssetsManager\"); \r\n\r\nvar amManager = cc.Class({\r\n    ctor : function(){\r\n        this._updates    = {};            // 更新模块集合\r\n        this._queue      = [];            // 更新对列\r\n        this._isUpdating = false;         // 是否正在更新中\r\n        this._current    = null;          // 当前正在更新的模块\r\n        this._noComplete = {};            // 上次未完成的热更项\r\n    }, \r\n\r\n    /** \r\n     * 获取模块版本信息 \r\n     * @param localVersionCb(function)    本地版本信息加载完成\r\n     * @param remoteVersionCb(function)   远程版本信息加载完成\r\n     * \r\n     */\r\n    getModules : function(remoteVersionCb){\r\n        if (!cc.sys.isNative) {\r\n            if (remoteVersionCb) remoteVersionCb();\r\n            return;\r\n        }\r\n\r\n        game.asset.check(function(modules, versions){\r\n             this.modules  = modules;\r\n             this.versions = versions;\r\n             if (remoteVersionCb) remoteVersionCb();\r\n        }.bind(this));\r\n    },\r\n\r\n    /** 载入没更新完的模块状态 */\r\n    load : function(){\r\n        if (!cc.sys.isNative) return; \r\n        \r\n        var data = cc.sys.localStorage.getItem(\"update_no_complete\");\r\n        if (data){\r\n            var json = JSON.parse(data);\r\n            for(var i = 0; i < json.length; i++){\r\n                this._noComplete[json[i]] = json[i];\r\n            }\r\n            cc.sys.localStorage.removeItem(\"update_no_complete\"); \r\n        }\r\n    },\r\n\r\n    getProgress : function(name){\r\n        var am = this._updates[name];\r\n        return am.getProgress();\r\n    },\r\n   \r\n    /**\r\n     * 初始化更新模块名\r\n     * @param name(string)                 模块名\r\n     * @param onCheckComplete(function)    检查版本完成\r\n     * @param onComplete(function)         模块名\r\n     * @param onProgress(function)         更新完成\r\n     * @param onNewVersion(function)       已是最新版本\r\n     */\r\n    init : function(name, onCheckComplete, onComplete, onProgress, onNewVersion) {\r\n        game.AssetConfig.concurrent = 2;\r\n        \r\n        var am = new AssetsManager();\r\n        am.name = name;\r\n        am.on(game.AssetEvent.NEW_VERSION                       , onNewVersion); \r\n        am.on(game.AssetEvent.PROGRESS                          , onProgress); \r\n        am.on(game.AssetEvent.FAILD                             , this._onFailed.bind(this)); \r\n        am.on(game.AssetEvent.NEW_VERSION_FOUND                 , this._onCheckComplete.bind(this)); \r\n        am.on(game.AssetEvent.SUCCESS                           , this._onUpdateComplete.bind(this)); \r\n        am.on(game.AssetEvent.REMOTE_VERSION_MANIFEST_LOAD_FAILD, this._onNetError.bind(this)); \r\n        am.on(game.AssetEvent.REMOTE_PROJECT_MANIFEST_LOAD_FAILD, this._onNetError.bind(this)); \r\n        am.on(game.AssetEvent.NO_NETWORK                        , this._onNetError.bind(this)); \r\n        am.onCheckComplete = onCheckComplete;\r\n        am.onComplete      = onComplete;\r\n\r\n        this._updates[name] = am;\r\n    },\r\n\r\n    /** 是否没完成 */\r\n    isNoComplete : function(name){\r\n        if (this._noComplete[name] == null)\r\n            return false;\r\n        \r\n        return true;\r\n    },\r\n\r\n    /**\r\n     * 检查版本是否需要更新\r\n     */\r\n    check : function(name){\r\n        var am = this._updates[name];\r\n        am.check(name);\r\n    },\r\n\r\n    /** 断网后恢复状态 */\r\n    recovery : function(name){\r\n        if (this._current && this._isUpdating == false){\r\n            this._isUpdating = true;\r\n            this._current.recovery();\r\n        }\r\n    },\r\n\r\n    _onFailed : function(event){\r\n        this._isUpdating = false;\r\n        event.target.check(event.target.name);\r\n    },\r\n\r\n    _onNetError : function(event){\r\n        this._isUpdating = false;\r\n    },\r\n\r\n    /** 检查版本完成 */\r\n    _onCheckComplete : function(event){\r\n        this._queue.push(event.target);\r\n        \r\n        // 保存下在下载的模块状态\r\n        this._saveNoCompleteModule();\r\n\r\n        if (event.target.onCheckComplete) event.target.onCheckComplete();\r\n\r\n        if (this._isUpdating == false){\r\n            this._isUpdating = true;\r\n            this._current = event.target;\r\n            this._current.update();\r\n        }\r\n    },\r\n\r\n    _onUpdateComplete : function(event){\r\n        if (event.target.onComplete) event.target.onComplete();  \r\n\r\n        // 删除当前完成的更新对象\r\n        this._queue.shift();\r\n        this._isUpdating = false;\r\n\r\n        // 保存下在下载的模块状态\r\n        this._saveNoCompleteModule();\r\n\r\n        // 更新对列中下一个更新对象\r\n        if (this._queue.length > 0){\r\n            this._isUpdating = true;\r\n            this._current = this._queue[0];\r\n            this._current.update();\r\n        }\r\n    },\r\n\r\n    // 保存下在下载的模块状态\r\n    _saveNoCompleteModule : function(){\r\n        var names = [];\r\n        for(var i = 0; i < this._queue.length; i++){\r\n            names.push(this._queue[i].name);\r\n        }\r\n        cc.sys.localStorage.setItem(\"update_no_complete\", JSON.stringify(names)); \r\n    }\r\n});"
  ]
}